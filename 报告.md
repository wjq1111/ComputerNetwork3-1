<center><span style="font-size:25px">实验3-1：基于UDP服务设计可靠传输协议并编程实现</span></center>

<div align="right">
    1811439 吴继强
</div>


### 一、实验要求

​	利用数据报套接字在用户空间实现面向连接的可靠数据传输，功能包括：建立连接、差错检测、确认重传。流量控制采用停等机制，完成给定测试文件的传输。

### 二、实验环境

- Visual Studio 2017

### 三、实验设计

- 建立连接：三次握手

  客户端向服务器发送长度为2的标志，包含SEQ和ACK码（此时SEQ码为预设值，ACK码为随机值）

  服务器收到第一次握手之后，检查SEQ码是否和预设值相同，若相同，发给客户端长度为2的标志（此时SEQ码为随机值，ACK码为上一次SEQ码+1）

  客户端收到第三次握手之后，检查ACK码是否正确，若正确，建立连接成功并发送第三次握手信息（但是第三次握手信息不会被服务器接收了）

- 报文设计：

  每一个报文长度为16384字节，其中，第0位表示此包是否为本次发送的最后一个包，第1位和第2位共同表示这个包是第几个包，第3位和第4位共同表示这个包有多长，第5位为一个校验码，后面的16378位为报文长度

  将本地文件进行二进制读入到程序中，并把它每16378位进行分装，对于不是最后的包，长度恒定，对于最后一个包，有多少发多少，同时标志位显示这个包是最后一个。

- 差错检测：

  在本地程序中存储static变量两位pindex表示上一次该接收的是第几个包，每接到一个包就进行一次校验。因为停等机制，不会出现包乱序发送的情况，所以这里的pindex是递增的。同时，检测校验码是否一致。上述均符合，将发回一个ACK标志，客户端收到将发送下一个包，否则，客户端继续这个包的发送。

  同样的，如果服务器接到的报文校验码不正确，将不会进行文件的载入（本地存储），而是会继续等待正确的包。

- 超时检测：

  在发送报文之后开始计时器（采用time.h中的clock()函数记录时间），如果接收函数返回SOCKET_ERROR，且超时，没有收到服务器发来的ACK/NAK标志，那么客户端将重新发送这个包。

- 断开连接：两次握手

  客户端向服务器发送长度为2的标志，包含WAVE1和ACK码（WAVE为预设，ACK码随机），关闭客户端

  服务器接收第一次挥手之后，检查WAVE1码是否和预设值相同，若相同，发送WAVE2和ACK码（WAVE2随机，ACK为WAVE1+1）,关闭服务器（但客户端是接不到的）